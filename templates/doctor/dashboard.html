{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Мои визиты</h4>
    <a href="{{ url_for('doctor_add_visit') }}" class="btn btn-primary">Добавить визит</a>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Дата и время</th>
                        <th>Пациент</th>
                        <th>Местоположение</th>
                        <th>Диагноз</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visit in visits %}
                    <tr>
                        <td>{{ visit.date.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>{{ visit.patient_first_name }} {{ visit.patient_last_name }}</td>
                        <td>{{ visit.location }}</td>
                        <td>{{ visit.diagnosis[:50] }}{% if visit.diagnosis|length > 50 %}...{% endif %}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showVisitDetails('{{ visit.id }}')">
                                Подробнее
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center">Нет записей о визитах</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for visit details -->
<div class="modal fade" id="visitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали визита</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="visitDetails">
                Загрузка...
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function showVisitDetails(visitId) {
        fetch(`/doctor/visits/${visitId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    $('#visitDetails').html(`<div class="alert alert-danger">${data.error}</div>`);
                } else {
                    let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Пациент:</h6>
                            <p>${data.patient_first_name} ${data.patient_last_name}</p>
                            <p>Дата рождения: ${new Date(data.date_of_birth).toLocaleDateString()}</p>
                            <p>Пол: ${data.gender === 'M' ? 'Мужской' : 'Женский'}</p>
                            <p>Адрес: ${data.address || 'Не указан'}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Дата визита:</h6>
                            <p>${new Date(data.date).toLocaleString()}</p>
                            <h6>Местоположение:</h6>
                            <p>${data.location}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Симптомы:</h6>
                    <p>${data.symptoms || 'Не указаны'}</p>
                    <h6>Диагноз:</h6>
                    <p>${data.diagnosis || 'Не указан'}</p>
                    <h6>Назначения:</h6>
                    <p>${data.prescriptions || 'Не указаны'}</p>
                `;

                    if (data.medicines && data.medicines.length > 0) {
                        html += `<hr><h6>Назначенные лекарства:</h6>`;
                        data.medicines.forEach(med => {
                            html += `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>${med.name}</h6>
                                    <p><strong>Описание:</strong> ${med.description || 'Нет'}</p>
                                    <p><strong>Побочные эффекты:</strong> ${med.side_effects || 'Нет'}</p>
                                    <p><strong>Способ применения:</strong> ${med.usage_method || 'Нет'}</p>
                                    <p><strong>Инструкции врача:</strong> ${med.doctor_instructions || 'Нет'}</p>
                                </div>
                            </div>
                        `;
                        });
                    }

                    $('#visitDetails').html(html);
                }
                $('#visitModal').modal('show');
            })
            .catch(error => {
                $('#visitDetails').html('<div class="alert alert-danger">Ошибка загрузки данных</div>');
                $('#visitModal').modal('show');
            });
    }
</script>
{% endblock %}